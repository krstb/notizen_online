<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase Notizen ‚Äì Schnell & Sicher</title>

<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-blue-50 min-h-screen flex justify-center p-6">

<div class="w-full max-w-xl bg-white rounded-3xl shadow-xl p-8">

<h1 class="text-3xl font-bold text-center mb-6">Meine Notizen</h1>

<p id="status" class="text-center mb-4 text-slate-600">Status wird geladen‚Ä¶</p>

<div class="flex justify-center gap-3 mb-6">
<button id="login" class="bg-blue-600 text-white px-5 py-2 rounded-xl hidden">Mit Google anmelden</button>
<button id="logout" class="bg-red-500 text-white px-5 py-2 rounded-xl hidden">Abmelden</button>
</div>

<form id="form" class="flex gap-2 mb-6 hidden">
<input id="text" class="flex-1 border rounded-xl p-3" placeholder="Neue Notiz‚Ä¶">
<select id="priority" class="border rounded-xl p-3">
<option value="niedrig">Niedrig</option>
<option value="mittel">Mittel</option>
<option value="hoch">Hoch</option>
</select>
<button class="bg-cyan-600 text-white px-4 rounded-xl">+</button>
</form>

<div id="list" class="space-y-3 text-slate-800"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* üîß Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyAy_eDSW5Q9KzZFptsTK5DGthk1ed2Objc",
  authDomain: "notizentest-1bcdc.firebaseapp.com",
  projectId: "notizentest-1bcdc",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

/* üß† State */
let user = null;
let unsubscribe = null;

/* üì¶ DOM */
const status = document.getElementById("status");
const loginBtn = document.getElementById("login");
const logoutBtn = document.getElementById("logout");
const form = document.getElementById("form");
const list = document.getElementById("list");
const textInput = document.getElementById("text");
const priorityInput = document.getElementById("priority");

/* üîê Auth */
loginBtn.onclick = () => signInWithPopup(auth, provider);
logoutBtn.onclick = () => signOut(auth);

/* üëÄ Auth Observer */
onAuthStateChanged(auth, u => {
  user = u;
  if (u) {
    status.textContent = `Angemeldet als ${u.email}`;
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    form.classList.remove("hidden");
    listen();
  } else {
    status.textContent = "Bitte anmelden";
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
    form.classList.add("hidden");
    list.innerHTML = "";
    if (unsubscribe) unsubscribe();
  }
});

/* üì° Realtime Listener */
function listen() {
  const q = query(
    collection(db, `notes/${user.uid}/userNotes`),
    orderBy("createdAt", "desc")
  );

  unsubscribe = onSnapshot(q, snap => {
    list.innerHTML = "";
    snap.forEach(d => render(d.id, d.data()));
  });
}

/* ‚ûï Add */
form.onsubmit = async e => {
  e.preventDefault();
  if (!textInput.value.trim()) return;

  await addDoc(collection(db, `notes/${user.uid}/userNotes`), {
    text: textInput.value,
    priority: priorityInput.value,
    createdAt: serverTimestamp()
  });

  textInput.value = "";
};

/* üñº Render */
function render(id, note) {
  const div = document.createElement("div");
  div.className = "p-4 rounded-xl border flex justify-between";

  div.innerHTML = `
    <div>
      <p class="font-semibold">${note.text}</p>
      <p class="text-sm text-slate-500">${note.priority}</p>
    </div>
    <div class="flex gap-2">
      <button data-e="${id}">‚úèÔ∏è</button>
      <button data-d="${id}">üóë</button>
    </div>
  `;

  div.onclick = async e => {
    if (e.target.dataset.d)
      await deleteDoc(doc(db, `notes/${user.uid}/userNotes/${id}`));

    if (e.target.dataset.e) {
      const n = prompt("Bearbeiten:", note.text);
      if (n)
        await updateDoc(doc(db, `notes/${user.uid}/userNotes/${id}`), { text: n });
    }
  };

  list.appendChild(div);
}
</script>
</body>
</html>
